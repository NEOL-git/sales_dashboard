#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Î™®Îìà
Î∂ÑÏÑù Í≤∞Í≥ºÎ•º HTML Î≥¥Í≥†ÏÑúÎ°ú ÏÉùÏÑ±Ìï©ÎãàÎã§.
"""

import pandas as pd
from datetime import datetime
from jinja2 import Template
from config import COLORS, REPORT_CONFIG


class ReportGenerator:
    """HTML Î≥¥Í≥†ÏÑú ÏÉùÏÑ± ÌÅ¥ÎûòÏä§"""
    
    def __init__(self, data_info, kpis, analyzers):
        """
        Args:
            data_info: Îç∞Ïù¥ÌÑ∞ Ï†ïÎ≥¥ ÎîïÏÖîÎÑàÎ¶¨
            kpis: KPI Î∂ÑÏÑù Í≤∞Í≥º
            analyzers: Î∂ÑÏÑùÍ∏∞ Í∞ùÏ≤¥Îì§ (timeseries, product, customer, discount)
        """
        self.data_info = data_info
        self.kpis = kpis
        self.timeseries = analyzers['timeseries']
        self.product = analyzers['product']
        self.customer = analyzers['customer']
        self.discount = analyzers['discount']
        self.report_html = ""
    
    def generate_html(self):
        """Ï†ÑÏ≤¥ HTML Î≥¥Í≥†ÏÑúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§."""
        html_template = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_title }}</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', 'Arial', sans-serif;
            background-color: {{ colors.white }};
            color: {{ colors.dark_gray }};
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, {{ colors.primary_blue }} 0%, {{ colors.secondary_blue }} 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .section {
            background: {{ colors.white }};
            border: 1px solid {{ colors.border }};
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: {{ colors.primary_blue }};
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid {{ colors.primary_blue }};
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: {{ colors.light_gray }};
            border-left: 4px solid {{ colors.primary_blue }};
            padding: 20px;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .kpi-label {
            font-size: 14px;
            color: {{ colors.dark_gray }};
            margin-bottom: 8px;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: {{ colors.primary_blue }};
        }
        
        .chart-container {
            margin: 20px 0;
            background: {{ colors.white }};
            padding: 15px;
            border-radius: 8px;
        }
        
        .grid-2col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        table thead {
            background-color: {{ colors.primary_blue }};
            color: white;
        }
        
        table th {
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        table td {
            padding: 10px 12px;
            border-bottom: 1px solid {{ colors.neutral_gray }};
        }
        
        table tbody tr:nth-child(even) {
            background-color: {{ colors.light_gray }};
        }
        
        table tbody tr:hover {
            background-color: {{ colors.neutral_gray }};
        }
        
        table td.number {
            text-align: right;
        }
        
        table td.text-center {
            text-align: center;
        }
        
        table td.category-name {
            font-weight: bold;
        }
        
        table tr.group-header-row {
            background-color: #F0F7FC;
        }
        
        table tr.group-header-row:hover {
            background-color: #E3F2FD;
        }
        
        table tr.group-separator {
            height: 2px;
        }
        
        table tr.group-separator td {
            padding: 0;
            border: none;
        }
        
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: {{ colors.dark_gray }};
            font-size: 14px;
            border-top: 1px solid {{ colors.border }};
            margin-top: 40px;
        }
        
        .data-info {
            background: {{ colors.light_gray }};
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .data-info-item {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 10px;
        }
        
        .data-info-label {
            font-weight: bold;
            color: {{ colors.dark_gray }};
        }
        
        @media print {
            .section {
                page-break-inside: avoid;
            }
        }
        
        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ìó§Îçî -->
        <div class="header">
            <h1>{{ report_title }}</h1>
            <div class="subtitle">{{ data_period }}</div>
            <div class="subtitle">Î≥¥Í≥†ÏÑú ÏÉùÏÑ±Ïùº: {{ generated_date }}</div>
        </div>
        
        <!-- Îç∞Ïù¥ÌÑ∞ Í∞úÏöî -->
        <div class="data-info">
            <div class="data-info-item">
                <span class="data-info-label">Îç∞Ïù¥ÌÑ∞ Í∏∞Í∞Ñ:</span> {{ data_start }} ~ {{ data_end }}
            </div>
            <div class="data-info-item">
                <span class="data-info-label">Ï¥ù Í±∞Îûò Í±¥Ïàò:</span> {{ total_records }}Í±¥
            </div>
            <div class="data-info-item">
                <span class="data-info-label">Í±∞ÎûòÏ≤ò Ïàò:</span> {{ customer_count }}Í∞ú
            </div>
            <div class="data-info-item">
                <span class="data-info-label">Ï†úÌíà Ï¢ÖÎ•ò:</span> {{ product_count }}Ï¢Ö
            </div>
        </div>
        
        <!-- 1. ÎåÄÏãúÎ≥¥Îìú Í∞úÏöî (KPI) -->
        <div class="section">
            <h2 class="section-title">üìä 1. ÎåÄÏãúÎ≥¥Îìú Í∞úÏöî</h2>
            <div class="kpi-grid">
                {% for kpi in main_kpis %}
                <div class="kpi-card">
                    <div class="kpi-label">{{ kpi.label }}</div>
                    <div class="kpi-value">{{ kpi.formatted }}</div>
                </div>
                {% endfor %}
            </div>
            <div class="kpi-grid">
                {% for kpi in sub_kpis %}
                <div class="kpi-card">
                    <div class="kpi-label">{{ kpi.label }}</div>
                    <div class="kpi-value">{{ kpi.formatted }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 2. ÏãúÍ≥ÑÏó¥ Î∂ÑÏÑù -->
        <div class="section">
            <h2 class="section-title">üìà 2. ÏãúÍ≥ÑÏó¥ Î∂ÑÏÑù</h2>
            <div class="chart-container">
                <div id="monthly-sales-chart"></div>
            </div>
            <div class="grid-2col">
                <div class="chart-container">
                    <div id="monthly-transactions-chart"></div>
                </div>
                <div class="chart-container">
                    <div id="quarterly-sales-chart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div id="weekday-chart"></div>
            </div>
        </div>
        
        <!-- 3. Ï†úÌíà Î∂ÑÏÑù -->
        <div class="section">
            <h2 class="section-title">üì¶ 3. Ï†úÌíà Î∂ÑÏÑù</h2>
            <div class="grid-2col">
                <div class="chart-container">
                    <div id="category-pie-chart"></div>
                </div>
                <div class="chart-container">
                    <div id="category-bar-chart"></div>
                </div>
            </div>
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: {{ colors.primary_blue }};">Ï†úÌíà Î∂ÑÎ•òÎ≥Ñ TOP 3 Îß§Ï∂ú</h3>
            {{ top_products_by_category_table }}
            <div class="chart-container">
                <div id="price-distribution-chart"></div>
            </div>
        </div>
        
        <!-- 4. Í±∞ÎûòÏ≤ò Î∂ÑÏÑù -->
        <div class="section">
            <h2 class="section-title">üè¢ 4. Í±∞ÎûòÏ≤ò Î∂ÑÏÑù</h2>
            <div class="chart-container">
                <div id="top-customers-chart"></div>
            </div>
            <div class="chart-container">
                <div id="customer-transactions-chart"></div>
            </div>
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: {{ colors.primary_blue }};">Ï£ºÏöî Í±∞ÎûòÏ≤ò ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h3>
            {{ customer_detail_table }}
        </div>
        
        <!-- 5. Ìï†Ïù∏ Î∂ÑÏÑù -->
        <div class="section">
            <h2 class="section-title">üí∞ 5. Ìï†Ïù∏ Î∂ÑÏÑù</h2>
            <div class="grid-2col">
                <div class="chart-container">
                    <div id="discount-application-chart"></div>
                </div>
                {% if discount_rate_chart %}
                <div class="chart-container">
                    <div id="discount-rate-chart"></div>
                </div>
                {% endif %}
            </div>
            <div class="chart-container">
                <div id="category-discount-chart"></div>
            </div>
        </div>
        
        <!-- Ìë∏ÌÑ∞ -->
        <div class="footer">
            <p>Ïù¥ Î≥¥Í≥†ÏÑúÎäî ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.</p>
            <p>Î¨∏ÏùòÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÏãúÎ©¥ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÌåÄÏúºÎ°ú Ïó∞ÎùΩ Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.</p>
        </div>
    </div>
    
    <!-- Ï∞®Ìä∏ Î†åÎçîÎßÅ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script>
        {{ chart_scripts }}
    </script>
</body>
</html>
        """
        
        # ÌÖúÌîåÎ¶ø Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
        template_data = self._prepare_template_data()
        
        # Jinja2 ÌÖúÌîåÎ¶ø Î†åÎçîÎßÅ
        template = Template(html_template)
        self.report_html = template.render(**template_data)
        
        return self.report_html
    
    def _prepare_template_data(self):
        """ÌÖúÌîåÎ¶øÏóê Ï†ÑÎã¨Ìï† Îç∞Ïù¥ÌÑ∞Î•º Ï§ÄÎπÑÌï©ÎãàÎã§."""
        # KPI ÏöîÏïΩ
        kpi_summary = self.kpis
        
        # Ï†úÌíà Î∂ÑÎ•òÎ≥Ñ TOP 3 ÌÖåÏù¥Î∏î
        top_products_by_category = self.product.get_top_products_by_category(3)
        top_products_formatted = top_products_by_category.copy()
        top_products_formatted['Îß§Ï∂úÏï°'] = top_products_formatted['Îß§Ï∂úÏï°'].apply(lambda x: f"‚Ç©{x:,.0f}")
        top_products_formatted.columns = ['Î∂ÑÎ•òÎ™Ö', 'ÏàúÏúÑ', 'Ï†úÌíàÎ™Ö', 'Îß§Ï∂úÏï°', 'Í±∞ÎûòÍ±¥Ïàò', 'ÌåêÎß§ÏàòÎüâ']
        top_products_html = self._df_to_html_table_grouped(top_products_formatted, 'Î∂ÑÎ•òÎ™Ö')
        
        # Í±∞ÎûòÏ≤ò ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î
        customer_detail = self.customer.get_customer_detail().head(15)
        customer_detail_formatted = customer_detail.copy()
        customer_detail_formatted['Îß§Ï∂úÏï°'] = customer_detail_formatted['Îß§Ï∂úÏï°'].apply(lambda x: f"‚Ç©{x:,.0f}")
        customer_detail_formatted['ÌèâÍ∑†Í±∞ÎûòÍ∏àÏï°'] = customer_detail_formatted['ÌèâÍ∑†Í±∞ÎûòÍ∏àÏï°'].apply(lambda x: f"‚Ç©{x:,.0f}")
        customer_detail_formatted['Îß§Ï∂úÎπÑÏ§ë'] = customer_detail_formatted['Îß§Ï∂úÎπÑÏ§ë'].apply(lambda x: f"{x}%")
        customer_detail_html = self._df_to_html_table(customer_detail_formatted)
        
        # Ï∞®Ìä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
        chart_scripts = self._generate_chart_scripts()
        
        # Îç∞Ïù¥ÌÑ∞ Í∏∞Í∞Ñ Ìè¨Îß∑ÌåÖ
        data_start = self.data_info['Îç∞Ïù¥ÌÑ∞_ÏãúÏûëÏùº'].strftime('%YÎÖÑ %mÏõî %dÏùº')
        data_end = self.data_info['Îç∞Ïù¥ÌÑ∞_Ï¢ÖÎ£åÏùº'].strftime('%YÎÖÑ %mÏõî %dÏùº')
        data_period = f"{data_start} ~ {data_end}"
        
        return {
            'report_title': REPORT_CONFIG['title'],
            'generated_date': datetime.now().strftime('%YÎÖÑ %mÏõî %dÏùº %H:%M'),
            'data_period': data_period,
            'data_start': data_start,
            'data_end': data_end,
            'total_records': f"{self.data_info['Ï¥ù_Í±∞ÎûòÍ±¥Ïàò']:,}",
            'customer_count': self.data_info['Í±∞ÎûòÏ≤ò_Ïàò'],
            'product_count': self.data_info['Ï†úÌíà_Ïàò'],
            'colors': COLORS,
            'main_kpis': kpi_summary['main_kpis'],
            'sub_kpis': kpi_summary['sub_kpis'],
            'top_products_by_category_table': top_products_html,
            'customer_detail_table': customer_detail_html,
            'discount_rate_chart': self.discount.get_discount_rate_distribution().empty == False,
            'chart_scripts': chart_scripts
        }
    
    def _df_to_html_table(self, df):
        """Îç∞Ïù¥ÌÑ∞ÌîÑÎ†àÏûÑÏùÑ HTML ÌÖåÏù¥Î∏îÎ°ú Î≥ÄÌôòÌï©ÎãàÎã§."""
        html = "<table>\n<thead>\n<tr>\n"
        for col in df.columns:
            html += f"<th>{col}</th>\n"
        html += "</tr>\n</thead>\n<tbody>\n"
        
        for _, row in df.iterrows():
            html += "<tr>\n"
            for val in row:
                # Î™®Îì† Ïª¨ÎüºÏùÑ ÏôºÏ™Ω Ï†ïÎ†¨
                html += f"<td>{val}</td>\n"
            html += "</tr>\n"
        
        html += "</tbody>\n</table>"
        return html
    
    def _df_to_html_table_grouped(self, df, group_column):
        """Îç∞Ïù¥ÌÑ∞ÌîÑÎ†àÏûÑÏùÑ Í∑∏Î£πÎ≥ÑÎ°ú Íµ¨Î∂ÑÎêú HTML ÌÖåÏù¥Î∏îÎ°ú Î≥ÄÌôòÌï©ÎãàÎã§."""
        html = "<table>\n<thead>\n<tr>\n"
        for col in df.columns:
            html += f"<th>{col}</th>\n"
        html += "</tr>\n</thead>\n<tbody>\n"
        
        current_group = None
        for idx, row in df.iterrows():
            group_value = row[group_column]
            
            # Í∑∏Î£πÏù¥ Î∞îÎÄî Îïå Íµ¨Î∂ÑÏÑ†Í≥º Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
            if current_group != group_value:
                if current_group is not None:
                    # Í∑∏Î£π Íµ¨Î∂ÑÏÑ† Ï∂îÍ∞Ä
                    html += "<tr class='group-separator'><td colspan='{}' style='height: 2px; background-color: {}'></td></tr>\n".format(
                        len(df.columns), COLORS['primary_blue']
                    )
                current_group = group_value
                row_class = 'group-header-row'
            else:
                row_class = 'group-row'
            
            html += f"<tr class='{row_class}'>\n"
            for i, val in enumerate(row):
                # Î™®Îì† Ïª¨ÎüºÏùÑ ÏôºÏ™Ω Ï†ïÎ†¨ÌïòÎêò, Î∂ÑÎ•òÎ™ÖÏùÄ ÏÉâÏÉÅÍ≥º ÍµµÍ∏∞ Ïú†ÏßÄ
                if i == 0:  # Î∂ÑÎ•òÎ™Ö
                    css_class = 'category-name'
                    style = f"font-weight: bold; color: {COLORS['primary_blue']};"
                else:
                    css_class = ''
                    style = ""
                
                html += f"<td class='{css_class}' style='{style}'>{val}</td>\n"
            html += "</tr>\n"
        
        html += "</tbody>\n</table>"
        return html
    
    def _generate_chart_scripts(self):
        """Î™®Îì† Ï∞®Ìä∏Ïùò Plotly Ïä§ÌÅ¨Î¶ΩÌä∏Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§."""
        scripts = []
        
        # ÏãúÍ≥ÑÏó¥ Ï∞®Ìä∏
        scripts.append(self._fig_to_script(self.timeseries.create_monthly_sales_chart(), 'monthly-sales-chart'))
        scripts.append(self._fig_to_script(self.timeseries.create_monthly_transactions_chart(), 'monthly-transactions-chart'))
        scripts.append(self._fig_to_script(self.timeseries.create_quarterly_sales_chart(), 'quarterly-sales-chart'))
        scripts.append(self._fig_to_script(self.timeseries.create_weekday_chart(), 'weekday-chart'))
        
        # Ï†úÌíà Ï∞®Ìä∏
        scripts.append(self._fig_to_script(self.product.create_category_pie_chart(), 'category-pie-chart'))
        scripts.append(self._fig_to_script(self.product.create_category_bar_chart(), 'category-bar-chart'))
        scripts.append(self._fig_to_script(self.product.create_price_distribution_chart(), 'price-distribution-chart'))
        
        # Í±∞ÎûòÏ≤ò Ï∞®Ìä∏
        scripts.append(self._fig_to_script(self.customer.create_top_customers_chart(), 'top-customers-chart'))
        scripts.append(self._fig_to_script(self.customer.create_customer_transaction_chart(), 'customer-transactions-chart'))
        
        # Ìï†Ïù∏ Ï∞®Ìä∏
        scripts.append(self._fig_to_script(self.discount.create_discount_application_chart(), 'discount-application-chart'))
        
        discount_rate_chart = self.discount.create_discount_rate_chart()
        if discount_rate_chart:
            scripts.append(self._fig_to_script(discount_rate_chart, 'discount-rate-chart'))
        
        scripts.append(self._fig_to_script(self.discount.create_category_discount_chart(), 'category-discount-chart'))
        
        return '\n'.join(scripts)
    
    def _fig_to_script(self, fig, div_id):
        """Plotly FigureÎ•º JavaScript Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú Î≥ÄÌôòÌï©ÎãàÎã§."""
        if fig is None:
            return ""
        
        import json
        import numpy as np
        
        def convert_to_serializable(obj):
            """Plotly Í∞ùÏ≤¥Î•º JSON ÏßÅÎ†¨Ìôî Í∞ÄÎä•Ìïú ÌòïÌÉúÎ°ú Î≥ÄÌôò"""
            if obj is None:
                return None
            elif isinstance(obj, (int, float, str, bool)):
                return obj
            elif isinstance(obj, (list, tuple)):
                return [convert_to_serializable(item) for item in obj]
            elif isinstance(obj, dict):
                return {key: convert_to_serializable(value) for key, value in obj.items()}
            elif isinstance(obj, np.ndarray):
                return obj.tolist()
            elif hasattr(obj, 'tolist'):  # pandas Series Îì±
                return obj.tolist()
            elif hasattr(obj, 'to_plotly_json'):  # Plotly Í∞ùÏ≤¥
                return obj.to_plotly_json()
            elif hasattr(obj, '__dict__'):  # Îã§Î•∏ Í∞ùÏ≤¥
                return {key: convert_to_serializable(value) for key, value in obj.__dict__.items() if not key.startswith('_')}
            else:
                return str(obj)
        
        # FigureÏùò Îç∞Ïù¥ÌÑ∞Î•º JSON ÏßÅÎ†¨Ìôî Í∞ÄÎä•Ìïú ÌòïÌÉúÎ°ú Î≥ÄÌôò
        data = []
        for trace in fig.data:
            trace_json = trace.to_plotly_json()
            # numpy Î∞∞Ïó¥ÏùÑ Î¶¨Ïä§Ìä∏Î°ú Î≥ÄÌôò
            for key, value in trace_json.items():
                if isinstance(value, np.ndarray):
                    trace_json[key] = value.tolist()
                elif hasattr(value, 'tolist'):
                    trace_json[key] = value.tolist()
            data.append(trace_json)
        
        # LayoutÎèÑ ÎîïÏÖîÎÑàÎ¶¨Î°ú Î≥ÄÌôò
        layout = fig.layout.to_plotly_json()
        
        config = {
            'displayModeBar': True,
            'displaylogo': False,
            'modeBarButtonsToRemove': ['pan2d', 'lasso2d', 'select2d'],
            'locale': 'ko'
        }
        
        # JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
        data_json = json.dumps(data, ensure_ascii=False)
        layout_json = json.dumps(layout, ensure_ascii=False)
        config_json = json.dumps(config)
        
        return f"Plotly.newPlot('{div_id}', {data_json}, {layout_json}, {config_json});"
    
    def save_report(self, output_path):
        """Î≥¥Í≥†ÏÑúÎ•º HTML ÌååÏùºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§."""
        if not self.report_html:
            self.generate_html()
        
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(self.report_html)
        
        print(f"‚úì Î≥¥Í≥†ÏÑú Ï†ÄÏû• ÏôÑÎ£å: {output_path}")

